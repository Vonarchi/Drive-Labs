"use strict";(()=>{var e={};e.id=302,e.ids=[302],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9491:e=>{e.exports=require("assert")},4300:e=>{e.exports=require("buffer")},2361:e=>{e.exports=require("events")},7147:e=>{e.exports=require("fs")},8188:e=>{e.exports=require("module")},5714:e=>{e.exports=require("node:diagnostics_channel")},5673:e=>{e.exports=require("node:events")},612:e=>{e.exports=require("node:os")},9411:e=>{e.exports=require("node:path")},1017:e=>{e.exports=require("path")},7310:e=>{e.exports=require("url")},3837:e=>{e.exports=require("util")},1267:e=>{e.exports=require("worker_threads")},7900:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>m,originalPathname:()=>f,requestAsyncStorage:()=>v,routeModule:()=>c,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>_});var o={};t.r(o),t.d(o,{POST:()=>POST});var i=t(1724),n=t(4089),a=t(4517),s=t(7674),l=t.n(s);let p=l()({level:process.env.LOG_LEVEL||"info",transport:void 0,serializers:{req:e=>({method:e.method,url:e.url,headers:{"user-agent":e.headers["user-agent"],"content-type":e.headers["content-type"],"content-length":e.headers["content-length"]},remoteAddress:e.remoteAddress}),res:e=>({statusCode:e.statusCode,headers:{"content-type":e.headers["content-type"],"content-length":e.headers["content-length"]}})}});function logApiCall(e,r,t,o){p.info({endpoint:e,method:r,requestSize:JSON.stringify(t).length,responseSize:JSON.stringify(o).length,timestamp:new Date().toISOString(),msg:"API call completed"})}function logError(e,r={}){p.error({err:e,...r,msg:"Error occurred"})}function logger_logSecurityEvent(e,r){p.warn({securityEvent:e,...r,msg:"Security event detected"})}let d={MAX_FILES:100,MAX_FILE_SIZE:1048576,MAX_TOTAL_SIZE:52428800};function validateGeneratedFiles(e){let r=[];e.length>d.MAX_FILES&&r.push(`Too many generated files (max ${d.MAX_FILES})`);let t=0;for(let o of e)o.data.length>d.MAX_FILE_SIZE&&r.push(`File ${o.path} too large (max ${d.MAX_FILE_SIZE} bytes)`),t+=o.data.length;return t>d.MAX_TOTAL_SIZE&&r.push(`Total generated size too large (max ${d.MAX_TOTAL_SIZE} bytes)`),{valid:0===r.length,errors:r}}let u=new Map;function checkRateLimit(e,r=10,t=6e4){let o=Date.now(),i=u.get(e);return!i||o>i.resetTime?(u.set(e,{count:1,resetTime:o+t}),!0):i.count>=r?(logger_logSecurityEvent("rate_limit_exceeded",{ip:e,limit:r,windowMs:t}),!1):(i.count++,!0)}async function POST(e){let r=Date.now(),t=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown";try{if(!checkRateLimit(t,3,6e4))return logger_logSecurityEvent("rate_limit_exceeded",{ip:t,endpoint:"/api/preview/vercel"}),a.Z.json({error:"Rate limit exceeded. Please try again later."},{status:429});let{files:o,name:i}=await e.json();if(!o||"object"!=typeof o)return a.Z.json({error:"Invalid files provided"},{status:400});let n=Object.entries(o).map(([e,r])=>({path:e,data:r})),s=validateGeneratedFiles(n);if(!s.valid)return logger_logSecurityEvent("preview_files_validation_failed",{ip:t,errors:s.errors,fileCount:n.length}),a.Z.json({error:"Files validation failed",details:s.errors},{status:400});if(i&&(i.length>50||!/^[a-zA-Z0-9\-_]+$/.test(i)))return logger_logSecurityEvent("invalid_deployment_name",{ip:t,name:i}),a.Z.json({error:"Invalid deployment name"},{status:400});p.info({endpoint:"/api/preview/vercel",clientIP:t,fileCount:n.length,name:i||"drive-labs-preview",msg:"Vercel preview request received"});let l=await fetch("https://api.vercel.com/v13/deployments",{method:"POST",headers:{Authorization:`Bearer ${process.env.VERCEL_TOKEN}`,"Content-Type":"application/json"},body:JSON.stringify({name:i||"drive-labs-preview",files:o,target:"preview",teamId:process.env.VERCEL_ORG_ID})}),d=await l.json();if(!l.ok)return logError(Error(`Vercel API error: ${l.status}`),{endpoint:"/api/preview/vercel",clientIP:t,vercelError:d}),a.Z.json({error:d},{status:l.status});let u=Date.now()-r;return logApiCall("/api/preview/vercel","POST",{fileCount:n.length,name:i||"drive-labs-preview"},{success:!0,deploymentId:d?.id,previewUrl:d?.url,duration:u}),a.Z.json({previewUrl:d?.url?`https://${d.url}`:null,deploymentId:d?.id,message:"âœ… Preview deployed successfully."})}catch(o){let e=Date.now()-r;return logError(o,{endpoint:"/api/preview/vercel",clientIP:t,duration:e}),a.Z.json({error:"Failed to deploy preview.",details:o instanceof Error?o.message:"Unknown error"},{status:500})}}let c=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/preview/vercel/route",pathname:"/api/preview/vercel",filename:"route",bundlePath:"app/api/preview/vercel/route"},resolvedPagePath:"/Users/jamesarchibald/drive-labs/app/api/preview/vercel/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:v,staticGenerationAsyncStorage:g,serverHooks:h,headerHooks:m,staticGenerationBailout:_}=c,f="/api/preview/vercel/route"}};var r=require("../../../../webpack-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),t=r.X(0,[297,674],()=>__webpack_exec__(7900));module.exports=t})();